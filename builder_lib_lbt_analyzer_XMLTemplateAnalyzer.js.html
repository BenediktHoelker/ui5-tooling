<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>builder/lib/lbt/analyzer/XMLTemplateAnalyzer.js - Documentation</title>

    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="AbstractAdapter.html">AbstractAdapter</a><ul class='methods'><li data-type='method'><a href="AbstractAdapter.html#_byPath">_byPath</a></li><li data-type='method'><a href="AbstractAdapter.html#_runGlob">_runGlob</a></li><li data-type='method'><a href="AbstractAdapter.html#_write">_write</a></li><li data-type='method'><a href="AbstractAdapter.html#byGlob">byGlob</a></li><li data-type='method'><a href="AbstractAdapter.html#byPath">byPath</a></li><li data-type='method'><a href="AbstractAdapter.html#write">write</a></li></ul></li><li><a href="AbstractBuilder.html">AbstractBuilder</a><ul class='methods'><li data-type='method'><a href="AbstractBuilder.html#addTask">addTask</a></li><li data-type='method'><a href="AbstractBuilder.html#build">build</a></li></ul></li><li><a href="AbstractFormatter.html">AbstractFormatter</a></li><li><a href="AbstractReader.html">AbstractReader</a><ul class='methods'><li data-type='method'><a href="AbstractReader.html#_byGlob">_byGlob</a></li><li data-type='method'><a href="AbstractReader.html#_byPath">_byPath</a></li><li data-type='method'><a href="AbstractReader.html#_runGlob">_runGlob</a></li><li data-type='method'><a href="AbstractReader.html#byGlob">byGlob</a></li><li data-type='method'><a href="AbstractReader.html#byPath">byPath</a></li></ul></li><li><a href="AbstractReaderWriter.html">AbstractReaderWriter</a><ul class='methods'><li data-type='method'><a href="AbstractReaderWriter.html#_byGlob">_byGlob</a></li><li data-type='method'><a href="AbstractReaderWriter.html#_byPath">_byPath</a></li><li data-type='method'><a href="AbstractReaderWriter.html#_runGlob">_runGlob</a></li><li data-type='method'><a href="AbstractReaderWriter.html#_write">_write</a></li><li data-type='method'><a href="AbstractReaderWriter.html#byGlob">byGlob</a></li><li data-type='method'><a href="AbstractReaderWriter.html#byPath">byPath</a></li><li data-type='method'><a href="AbstractReaderWriter.html#write">write</a></li></ul></li><li><a href="DuplexCollection.html">DuplexCollection</a><ul class='methods'><li data-type='method'><a href="DuplexCollection.html#_runGlob">_runGlob</a></li><li data-type='method'><a href="DuplexCollection.html#byGlob">byGlob</a></li><li data-type='method'><a href="DuplexCollection.html#byGlobSource">byGlobSource</a></li><li data-type='method'><a href="DuplexCollection.html#byPath">byPath</a></li><li data-type='method'><a href="DuplexCollection.html#write">write</a></li></ul></li><li><a href="FileSystem.html">FileSystem</a><ul class='methods'><li data-type='method'><a href="FileSystem.html#byGlob">byGlob</a></li><li data-type='method'><a href="FileSystem.html#byPath">byPath</a></li><li data-type='method'><a href="FileSystem.html#write">write</a></li></ul></li><li><a href="Memory.html">Memory</a><ul class='methods'><li data-type='method'><a href="Memory.html#byGlob">byGlob</a></li><li data-type='method'><a href="Memory.html#byPath">byPath</a></li><li data-type='method'><a href="Memory.html#write">write</a></li></ul></li><li><a href="ReaderCollection.html">ReaderCollection</a><ul class='methods'><li data-type='method'><a href="ReaderCollection.html#_runGlob">_runGlob</a></li><li data-type='method'><a href="ReaderCollection.html#byGlob">byGlob</a></li><li data-type='method'><a href="ReaderCollection.html#byPath">byPath</a></li></ul></li><li><a href="ReaderCollectionPrioritized.html">ReaderCollectionPrioritized</a><ul class='methods'><li data-type='method'><a href="ReaderCollectionPrioritized.html#_runGlob">_runGlob</a></li><li data-type='method'><a href="ReaderCollectionPrioritized.html#byGlob">byGlob</a></li><li data-type='method'><a href="ReaderCollectionPrioritized.html#byPath">byPath</a></li></ul></li><li><a href="Resource.html">Resource</a><ul class='methods'><li data-type='method'><a href="Resource.html#buffer">buffer</a></li><li data-type='method'><a href="Resource.html#clone">clone</a></li><li data-type='method'><a href="Resource.html#getBuffer">getBuffer</a></li><li data-type='method'><a href="Resource.html#getPath">getPath</a></li><li data-type='method'><a href="Resource.html#getPathTree">getPathTree</a></li><li data-type='method'><a href="Resource.html#getStatInfo">getStatInfo</a></li><li data-type='method'><a href="Resource.html#getStream">getStream</a></li><li data-type='method'><a href="Resource.html#getString">getString</a></li><li data-type='method'><a href="Resource.html#pushCollection">pushCollection</a></li><li data-type='method'><a href="Resource.html#setBuffer">setBuffer</a></li><li data-type='method'><a href="Resource.html#setPath">setPath</a></li><li data-type='method'><a href="Resource.html#setStream">setStream</a></li><li data-type='method'><a href="Resource.html#setString">setString</a></li></ul></li><li><a href="Trace.html">Trace</a></li></ul><h3>Modules</h3><ul><li><a href="module-builder_builder.html">builder/builder</a><ul class='methods'><li data-type='method'><a href="module-builder_builder.html#~build">build</a></li></ul></li><li><a href="module-builder_processors_bundlers_flexChangesBundler.html">builder/processors/bundlers/flexChangesBundler</a></li><li><a href="module-builder_processors_bundlers_manifestBundler.html">builder/processors/bundlers/manifestBundler</a></li><li><a href="module-builder_processors_bundlers_moduleBundler.html">builder/processors/bundlers/moduleBundler</a></li><li><a href="module-builder_processors_debugFileCreator.html">builder/processors/debugFileCreator</a></li><li><a href="module-builder_processors_resourceCopier.html">builder/processors/resourceCopier</a></li><li><a href="module-builder_processors_stringReplacer.html">builder/processors/stringReplacer</a></li><li><a href="module-builder_processors_themeBuilder.html">builder/processors/themeBuilder</a></li><li><a href="module-builder_processors_uglifier.html">builder/processors/uglifier</a></li><li><a href="module-builder_processors_versionInfoGenerator.html">builder/processors/versionInfoGenerator</a></li><li><a href="module-builder_tasks_buildThemes.html">builder/tasks/buildThemes</a></li><li><a href="module-builder_tasks_bundlers_generateBundle.html">builder/tasks/bundlers/generateBundle</a></li><li><a href="module-builder_tasks_bundlers_generateComponentPreload.html">builder/tasks/bundlers/generateComponentPreload</a></li><li><a href="module-builder_tasks_bundlers_generateFlexChangesBundle.html">builder/tasks/bundlers/generateFlexChangesBundle</a></li><li><a href="module-builder_tasks_bundlers_generateLibraryPreload.html">builder/tasks/bundlers/generateLibraryPreload</a></li><li><a href="module-builder_tasks_bundlers_generateManifestBundle.html">builder/tasks/bundlers/generateManifestBundle</a></li><li><a href="module-builder_tasks_bundlers_generateStandaloneAppBundle.html">builder/tasks/bundlers/generateStandaloneAppBundle</a></li><li><a href="module-builder_tasks_createDebugFiles.html">builder/tasks/createDebugFiles</a></li><li><a href="module-builder_tasks_generateLibraryManifest.html">builder/tasks/generateLibraryManifest</a></li><li><a href="module-builder_tasks_generateVersionInfo.html">builder/tasks/generateVersionInfo</a></li><li><a href="module-builder_tasks_replaceCopyright.html">builder/tasks/replaceCopyright</a></li><li><a href="module-builder_tasks_replaceVersion.html">builder/tasks/replaceVersion</a></li><li><a href="module-builder_tasks_uglify.html">builder/tasks/uglify</a></li><li><a href="module-init_init.html">init/init</a></li><li><a href="module-normalizer_normalizer.html">normalizer/normalizer</a><ul class='methods'><li data-type='method'><a href="module-normalizer_normalizer.html#~generateDependencyTree">generateDependencyTree</a></li><li data-type='method'><a href="module-normalizer_normalizer.html#~generateProjectTree">generateProjectTree</a></li></ul></li><li><a href="module-normalizer_translators_npm.html">normalizer/translators/npm</a><ul class='methods'><li data-type='method'><a href="module-normalizer_translators_npm.html#.generateDependencyTree">generateDependencyTree</a></li></ul></li><li><a href="module-normalizer_translators_static.html">normalizer/translators/static</a><ul class='methods'><li data-type='method'><a href="module-normalizer_translators_static.html#.processTree">processTree</a></li><li data-type='method'><a href="module-normalizer_translators_static.html#~generateDependencyTree">generateDependencyTree</a></li></ul></li><li><a href="module-resources_fsInterface.html">resources/fsInterface</a></li><li><a href="module-resources_resourceFactory.html">resources/resourceFactory</a><ul class='methods'><li data-type='method'><a href="module-resources_resourceFactory.html#~createAdapter">createAdapter</a></li><li data-type='method'><a href="module-resources_resourceFactory.html#~createCollectionsForTree">createCollectionsForTree</a></li><li data-type='method'><a href="module-resources_resourceFactory.html#~createResource">createResource</a></li><li data-type='method'><a href="module-resources_resourceFactory.html#~createWorkspace">createWorkspace</a></li></ul></li><li><a href="module-server_middleware_discovery.html">server/middleware/discovery</a></li><li><a href="module-server_middleware_nonReadRequests.html">server/middleware/nonReadRequests</a></li><li><a href="module-server_middleware_serveResources.html">server/middleware/serveResources</a></li><li><a href="module-server_middleware_serveThemes.html">server/middleware/serveThemes</a></li><li><a href="module-server_middleware_versionInfo.html">server/middleware/versionInfo</a></li><li><a href="module-server_server.html">server/server</a></li><li><a href="module-server_sslUtil.html">server/sslUtil</a></li></ul><h3>Global</h3><ul><li><a href="global.html#getStringArray">getStringArray</a></li></ul>
</nav>

<div id="main">
    
    <h1 class="page-title">builder/lib/lbt/analyzer/XMLTemplateAnalyzer.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>"use strict";

/*
 * TODOS
 * - find better way to distinguish between aggregation tags and control tags
 *   (currently, existence in pool is used to recognize controls)
 * - support alternative namespace URLs for libraries (as used by XSD files)
 * - make set of view types configurable
 * - plugin mechanism to support other special controls
 * - move UI5 specific constants to UI5ClientConstants?
 */

const xml2js = require("xml2js");
const ModuleName = require("../utils/ModuleName");
const log = require("@ui5/logger").getLogger("lbt:analyzer:XMLTemplateAnalyzer");

// ---------------------------------------------------------------------------------------------------------

const XHTML_NAMESPACE = "http://www.w3.org/1999/xhtml";
const SVG_NAMESPACE = "http://www.w3.org/2000/svg";
const TEMPLATING_NAMESPACE = "http://schemas.sap.com/sapui5/extension/sap.ui.core.template/1";
const TEMPLATING_CONDITONAL_TAGS = /^(?:if|repeat)$/;

const PATTERN_LIBRARY_NAMESPACES = /^([a-zA-Z_$][a-zA-z0-9_$]*(\.[a-zA-Z_$][a-zA-z0-9_$]*)*)$/;

// component container
const COMPONENTCONTAINER_MODULE = "sap/ui/core/ComponentContainer.js";
const COMPONENTCONTAINER_COMPONENTNAME_ATTRIBUTE = "name";

// fragment definition
const FRAGMENTDEFINITION_MODULE = "sap/ui/core/FragmentDefinition.js";

// fragment
const FRAGMENT_MODULE = "sap/ui/core/Fragment.js";
const FRAGMENT_FRAGMENTNAME_ATTRIBUTE = "fragmentName";
const FRAGMENT_TYPE_ATTRIBUTE = "type";

// different view types
const HTMLVIEW_MODULE = "sap/ui/core/mvc/HTMLView.js";
const JSVIEW_MODULE = "sap/ui/core/mvc/JSView.js";
const JSONVIEW_MODULE = "sap/ui/core/mvc/JSONView.js";
const XMLVIEW_MODULE = "sap/ui/core/mvc/XMLView.js";
const ANYVIEW_VIEWNAME_ATTRIBUTE = "viewName";
const XMLVIEW_CONTROLLERNAME_ATTRIBUTE = "controllerName";
const XMLVIEW_RESBUNDLENAME_ATTRIBUTE = "resourceBundleName";

/*
 * Helper to simplify access to node attributes.
 */
function getAttribute(node, attr) {
	return (node.$ &amp;&amp; node.$[attr] &amp;&amp; node.$[attr].value) || null;
}

/**
 * A dependency analyzer for XMLViews and XMLFragments.
 *
 * Parses the XML, collects controls and adds them as dependency to the ModuleInfo object.
 * Additionally, some special dependencies are handled:
 * &lt;ul>
 * &lt;li>controller of the view&lt;/li>
 * &lt;li>resource bundle (note: locale dependent dependencies can't be modeled yet in ModuleInfo&lt;/li>
 * &lt;li>component referenced via ComponentContainer control&lt;/li>
 * &lt;li>embedded fragments or views&lt;/li>
 * &lt;/ul>
 *
 * In an XMLView, there usually exist 3 categories of element nodes: controls, aggregations
 * of cardinality 'multiple' and non-UI5 nodes (e.g. XHTML or SVG). The third category usually
 * can be identified by its namespace (whitelisted). To distinguish between the first and the second
 * category, this analyzer uses a ResourcePool (provided by the caller and usually derived from the
 * library classpath). When the qualified node name is contained in the pool, it is assumed to
 * represent a control, otherwise it is ignored.
 *
 * In certain cases this might give wrong results, but loading the metadata for each control
 * to implement the exactly same logic as used in the runtime XMLTemplateProcessor would be to
 * expensive and require too much runtime.
 *
 * @author Frank Weigel
 * @since 1.23.0
 * @private
 */
class XMLTemplateAnalyzer {
	constructor(pool) {
		this._pool = pool;
		this._parser = new xml2js.Parser({
			explicitRoot: false,
			explicitChildren: true,
			preserveChildrenOrder: true,
			xmlns: true
		});
		this.busy = false;
	}

	/**
	 * Add a dependency if it is new.
	 *
	 * @param {string} moduleName
	 */
	_addDependency(moduleName) {
		// don't add references to 'self'
		if ( this.info.name === moduleName ) {
			return;
		}

		this.info.addDependency(moduleName, this.conditional);
	}

	/**
	 * Enrich the given ModuleInfo for an XMLView.
	 *
	 * @param {string} xml xml string to be analyzed
	 * @param {ModuleInfo} info ModuleInfo to enrich
	 * @returns {Promise&lt;ModuleInfo>} the created ModuleInfo
	 */
	analyzeView(xml, info) {
		return this._analyze(xml, info, false);
	}

	/**
	 * Enrich the given ModuleInfo for a fragment (XML).
	 *
	 * @param {string} xml xml string to be analyzed
	 * @param {ModuleInfo} info ModuleInfo to enrich
	 * @returns {Promise&lt;ModuleInfo>} the created ModuleInfo
	 */
	analyzeFragment(xml, info) {
		return this._analyze(xml, info, true);
	}

	_analyze(xml, info, isFragment) {
		if ( this.busy ) {
			// TODO delegate to fresh instances instead
			throw new Error("analyzer is busy");
		}

		this.info = info;
		this.conditional = false;
		this.promises = [];
		this.busy = true;

		return new Promise( (resolve, reject) => {
			this._parser.parseString(xml, (err, result) => {
				// parse error
				if ( err ) {
					this.busy = false;
					reject(err);
					return;
				}

				// console.log(result);
				// clear();
				if ( isFragment ) {
					// all fragments implicitly depend on the fragment class
					this.info.addImplicitDependency(FRAGMENT_MODULE);
					this._analyzeNode(result);
				} else {
					// views require a special handling of the root node
					this._analyzeViewRootNode(result);
				}

				Promise.all(this.promises).then( () => {
					this.busy = false;
					resolve(info);
				});
				// console.log("Collected info for %s:", info.name, info);
			});
		});
	}

	_analyzeViewRootNode(node) {
		this.info.addImplicitDependency(XMLVIEW_MODULE);

		const controllerName = getAttribute(node, XMLVIEW_CONTROLLERNAME_ATTRIBUTE);
		if ( controllerName ) {
			this._addDependency( ModuleName.fromUI5LegacyName(controllerName, ".controller.js") );
		}

		const resourceBundleName = getAttribute(node, XMLVIEW_RESBUNDLENAME_ATTRIBUTE);
		if ( resourceBundleName ) {
			const resourceBundleModuleName = ModuleName.fromUI5LegacyName(resourceBundleName, ".properties");
			log.verbose("found dependency to resource bundle %s", resourceBundleModuleName);
			// TODO locale dependent dependencies: this._addDependency(resourceBundleModuleName);
			this._addDependency( resourceBundleModuleName );
		}

		this._analyzeChildren(node);
	}

	_analyzeNode(node) {
		const namespace = node.$ns.uri || "";
		const localName = node.$ns.local;

		const oldConditional = this.conditional;

		if ( namespace === TEMPLATING_NAMESPACE ) {
			if ( TEMPLATING_CONDITONAL_TAGS.test(localName) ) {
				this.conditional = true;
			}
		} else if ( namespace === XHTML_NAMESPACE || namespace === SVG_NAMESPACE ) {

			// ignore XHTML and SVG nodes

		} else if ( PATTERN_LIBRARY_NAMESPACES.test(namespace) ) {
			// looks like a UI5 library or package name
			const moduleName = ModuleName.fromUI5LegacyName( (namespace ? namespace + "." : "") + localName );

			// ignore FragmentDefinition (also skipped by runtime XMLTemplateProcessor)
			if ( FRAGMENTDEFINITION_MODULE !== moduleName ) {
				this.promises.push(

					this._pool.findResource(moduleName).then( () => {
						this._addDependency(moduleName);

						// handle special controls that reference other entities via name
						// - (HTML|JS|JSON|XML)View reference another view by 'viewName'
						// - ComponentContainer reference another component by 'componentName'
						// - Fragment references a fragment by 'fragmentName' . 'type'

						if ( moduleName === COMPONENTCONTAINER_MODULE ) {
							const componentName = getAttribute(node, COMPONENTCONTAINER_COMPONENTNAME_ATTRIBUTE);
							if ( componentName ) {
								const componentModuleName =
									ModuleName.fromUI5LegacyName( componentName, "/Component.js" );
								this._addDependency(componentModuleName);
							}
							// TODO what about component.json? handle it transitively via Component.js?
						} else if ( moduleName === FRAGMENT_MODULE ) {
							const fragmentName = getAttribute(node, FRAGMENT_FRAGMENTNAME_ATTRIBUTE);
							const type = getAttribute(node, FRAGMENT_TYPE_ATTRIBUTE);
							if ( fragmentName &amp;&amp; type ) {
								const fragmentModuleName =
									ModuleName.fromUI5LegacyName( fragmentName, this._getFragmentExtension(type) );
								// console.log("child fragment detected %s", fragmentModuleName);
								this._addDependency(fragmentModuleName);
							}
						} else if ( moduleName === HTMLVIEW_MODULE ) {
							const viewName = getAttribute(node, ANYVIEW_VIEWNAME_ATTRIBUTE);
							if ( viewName ) {
								const childViewModuleName = ModuleName.fromUI5LegacyName( viewName, ".view.html" );
								// console.log("child view detected %s", childViewModuleName);
								this._addDependency(childViewModuleName);
							}
						} else if ( moduleName === JSVIEW_MODULE ) {
							const viewName = getAttribute(node, ANYVIEW_VIEWNAME_ATTRIBUTE);
							if ( viewName ) {
								const childViewModuleName = ModuleName.fromUI5LegacyName( viewName, ".view.js" );
								// console.log("child view detected %s", childViewModuleName);
								this._addDependency(childViewModuleName);
							}
						} else if ( moduleName === JSONVIEW_MODULE ) {
							const viewName = getAttribute(node, ANYVIEW_VIEWNAME_ATTRIBUTE);
							if ( viewName ) {
								const childViewModuleName = ModuleName.fromUI5LegacyName( viewName, ".view.json" );
								// console.log("child view detected %s", childViewModuleName);
								this._addDependency(childViewModuleName);
							}
						} else if ( moduleName === XMLVIEW_MODULE ) {
							const viewName = getAttribute(node, ANYVIEW_VIEWNAME_ATTRIBUTE);
							if ( viewName ) {
								const childViewModuleName = ModuleName.fromUI5LegacyName( viewName, ".view.xml" );
								// console.log("child view detected %s", childViewModuleName);
								this._addDependency(childViewModuleName);
							}
						}
					}, (err) => {
						// ignore missing resources
						// console.warn( "node not found %s", moduleName);
					})

				);
			}
		}

		this._analyzeChildren(node);

		// restore conditional state of the outer block
		this.conditional = oldConditional;
	}

	_analyzeChildren(node) {
		if ( Array.isArray(node.$$) ) {
			node.$$.forEach( (child) => this._analyzeNode( child ) );
		}
	}

	_getFragmentExtension(type) {
		return ".fragment." + type.toLowerCase();
	}
}


module.exports = XMLTemplateAnalyzer;
</code></pre>
        </article>
    </section>




</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.5.5</a> on Fri Jul 06 2018 15:10:48 GMT+0000 (UTC) using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>
</body>
</html>
